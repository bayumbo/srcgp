<!-- lista-reportes.component.html -->
<div class="modulos-barra">
  <button
    class="modulo-btn"
    [class.activo]="moduloActivo === 'cobros'"
    (click)="irACuentasPorCobrar()">
    Cuentas por cobrar
  </button>

  <button
    class="modulo-btn"
    [class.activo]="moduloActivo === 'cierre'"
    (click)="irACierreCaja()">
    Cierre de caja
  </button>
</div>

<div class="contenedor-reportes">

  <!-- Barra superior -->
  <div class="barra-superior">
    <button class="btn-secundario" type="button" (click)="volver()">‚Üê Volver</button>

    <div class="grupo-botones">
      <button class="btn-primario" type="button" (click)="abrirModalAgregarDia()" [disabled]="creandoDia">
        {{ creandoDia ? 'Creando d√≠a...' : 'Agregar d√≠a' }}
      </button>
    <button class="btn-secundario" type="button" (click)="abrirModalEliminarDia()" [disabled]="eliminandoDia">
      {{ eliminandoDia ? 'Eliminando...' : 'Eliminar d√≠a' }}
    </button>
      <!-- Subir Excel (Minutos) -->
      <button
        class="btn-primario"
        type="button"
        (click)="fileExcelMinutos.click()"
        [disabled]="subiendoExcel"
      >
        {{ subiendoExcel ? 'Subiendo Excel...' : 'Subir Excel (Min. Atraso)' }}
      </button>

      <input
        #fileExcelMinutos
        type="file"
        accept=".xlsx,.xls"
        style="display:none"
        (change)="onExcelMinutosSelected($event)"
      />

      <button class="btn-secundario" type="button" (click)="mostrarFiltros = !mostrarFiltros">
        Filtros
      </button>

      <button class="btn-primario" type="button" (click)="irANuevoRegistro()">
        + Nuevo Registro
      </button>
    </div>
  </div>

  <div class="excel-progreso" *ngIf="subiendoExcel">
    <p style="margin: 6px 0;">
      Procesando Excel... Total: {{ progresoExcel.total }} |
      OK: {{ progresoExcel.ok }} |
      Fallas: {{ progresoExcel.fail }}
    </p>
  </div>

  <!-- Panel Filtros -->
  <div class="panel-filtros" *ngIf="mostrarFiltros">
    <div class="filtros-rapidos">
      <button type="button" class="btn-chip" (click)="filtrarPor('hoy')">Hoy</button>
      <button type="button" class="btn-chip" (click)="filtrarPor('semana')">Esta semana</button>
      <button type="button" class="btn-chip" (click)="filtrarPor('mes')">Este mes</button>

      <!-- ‚úÖ Restaurado: toggle reporte empresas -->
      <button
        type="button"
        class="btn-chip"
        (click)="mostrarOpcionesEmpresa = !mostrarOpcionesEmpresa"
      >
        Reporte Empresas
      </button>

      <button
        type="button"
        class="btn-chip"
        (click)="mostrarOpcionesFinanciero = !mostrarOpcionesFinanciero"
      >
        Reporte Financiero
      </button>
    </div>

    <div class="filtro-fecha">
      <label for="fechaPersonalizada">Fecha:</label>
      <input
        id="fechaPersonalizada"
        type="date"
        [(ngModel)]="fechaPersonalizada"
        name="fechaPersonalizada"
        class="input-fecha"
      />
      <button type="button" class="btn-secundario" (click)="filtrarPorFechaPersonalizada()">
        Buscar
      </button>

    </div>

    <!-- ‚úÖ Panel Reporte Empresas (restaurado) -->
    <div class="panel-reporte-empresas" *ngIf="mostrarOpcionesEmpresa">
      <hr class="separador" />

      <div class="empresa-botones">
        <button
          type="button"
          class="btn-primario"
          [class.activo]="empresaSeleccionada === 'General Pintag'"
          (click)="seleccionarEmpresa('Pintag')"
        >
          Pintag
        </button>

        <button
          type="button"
          class="btn-primario"
          [class.activo]="empresaSeleccionada === 'Expreso Antisana'"
          (click)="seleccionarEmpresa('Antisana')"
        >
          Antisana
        </button>
      </div>

      <div class="rango-fechas">
        <div class="campo-fecha">
          <label for="fechaInicio">Inicio:</label>
          <input
            id="fechaInicio"
            type="date"
            [(ngModel)]="fechaInicio"
            name="fechaInicio"
            class="input-fecha"
            (change)="validarRangoFechas()"
          />
        </div>

        <div class="campo-fecha">
          <label for="fechaFin">Fin:</label>
          <input
            id="fechaFin"
            type="date"
            [(ngModel)]="fechaFin"
            name="fechaFin"
            class="input-fecha"
            (change)="validarRangoFechas()"
          />
        </div>

        <div class="error-fecha" *ngIf="errorFecha">
          {{ errorFecha }}
        </div>
      </div>

      <div class="acciones-empresa">
        <button
          type="button"
          class="btn-primario"
          (click)="generarReporteEmpresasPDF()"
          [disabled]="cargandoPDF || !empresaSeleccionada || !fechaInicio || !fechaFin || !!errorFecha"
        >
          {{ cargandoPDF ? 'Generando PDF...' : 'Generar PDF Empresa' }}
        </button>
      </div>
    </div>

    <hr class="separador" />

    <!-- PDFs del d√≠a (usa la vista actual: this.reportes) -->
    <div class="acciones-pdf">
      <button type="button" class="btn-secundario" (click)="imprimirPDFMinutosDesdeVista()">
        Imprimir PDF Minutos (vista)
      </button>

      <button type="button" class="btn-secundario" (click)="imprimirPDFAdministracionDesdeVista()">
        Imprimir PDF Administraci√≥n (vista)
      </button>

      <!-- ‚úÖ Restaurado: limpiar filtros -->
      <button class="Limpiar" type="button" class="btn info" (click)="limpiarFiltros()">
        Limpiar filtros
      </button>
    </div>
  </div>

  <!-- Mensajes / Estado -->
  <div class="estado-carga" *ngIf="cargando">
    <p>Cargando reportes...</p>
  </div>

  <div class="mensaje-dia" *ngIf="mostrarMensajeDia && !cargando">
    <p>{{ mensajeEstadoDia }}</p>
  </div>

  <!-- Barra selecci√≥n m√∫ltiple (sin checkboxes) -->
  <div class="acciones-multiples" *ngIf="seleccionCount > 0 && !cargando">
    <span class="seleccion-info">
      Seleccionados: {{ seleccionCount }} / {{ reportes.length }}
    </span>

    <button class="btn-eliminar-multi" type="button" (click)="eliminarSeleccionados()">
      Eliminar seleccionados
    </button>

    <button class="btn-limpiar-multi" type="button" (click)="limpiarSeleccion()">
      Limpiar selecci√≥n
    </button>
  </div>


  <!-- ‚úÖ Panel Reporte Financiero (consolida Pintag + Antisana) -->
  <div class="panel-reporte-empresas" *ngIf="mostrarOpcionesFinanciero">
    <hr class="separador" />

    <div class="rango-fechas">
      <div class="campo-fecha">
        <label>Periodo:</label>
        <select
          class="input-fecha"
          [(ngModel)]="periodoFinanciero"
          name="periodoFinanciero"
          (change)="actualizarRangoFinanciero()"
        >
          <option value="mensual">Mensual</option>
          <option value="trimestral">Trimestral</option>
          <option value="semestral">Semestral</option>
          <option value="nonamestral">Nonamestral</option>
          <option value="anual">Anual</option>
        </select>
      </div>

      <div class="campo-fecha">
        <label>Fecha inicio:</label>
        <input
          type="date"
          class="input-fecha"
          [(ngModel)]="fechaInicioFinanciero"
          name="fechaInicioFinanciero"
          (change)="actualizarRangoFinanciero()"
        />
      </div>

      <div class="campo-fecha">
        <label>Fecha fin (calculada):</label>
        <input
          type="date"
          class="input-fecha"
          [ngModel]="fechaFinFinanciero"
          name="fechaFinFinanciero"
          readonly
        />
      </div>
    </div>

    <div class="rango-fechas">
      <div class="campo-fecha">
        <label>Saldo anterior:</label>
        <input
          type="number"
          class="input-fecha"
          [(ngModel)]="saldoAnteriorInput"
          name="saldoAnteriorInput"
          min="0"
          step="0.01"
        />
      </div>

      <div class="campo-fecha">
        <label>Total egresos:</label>
        <input
          type="number"
          class="input-fecha"
          [(ngModel)]="totalEgresosInput"
          name="totalEgresosInput"
          min="0"
          step="0.01"
        />
      </div>
    </div>

    <div class="acciones-empresa">
      <button
        type="button"
        class="btn-primario"
        (click)="generarReporteFinancieroPorPeriodo()"
        [disabled]="cargandoPDF || !fechaInicioFinanciero || !fechaFinFinanciero"
      >
        {{ cargandoPDF ? 'Generando PDF...' : 'Generar Reporte Financiero' }}
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="tabla-wrapper" *ngIf="!cargando">
    <table class="tabla-reportes" *ngIf="reportes.length; else sinDatos">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Nombre</th>
          <th>Unidad</th>
          <th>Min. Atraso</th>
          <th>Min. Pagados</th>
          <th>Administraci√≥n</th>
          <th>Admin Pagada</th>
          <th>Min. Base</th>
          <th>Min. Base Pagados</th>
          <th>Multas</th>
          <th>Multas Pagadas</th>
          <th class="col-acciones">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr
          *ngFor="let r of reportes; trackBy: trackByReporte"
          (dblclick)="toggleSeleccionFila(r)"
          [class.fila-seleccionada]="isSelected(r)"
          title="Doble clic para seleccionar/deseleccionar"
        >
          <!-- Fecha -->
          <td>
            {{
              (r.fechaModificacion ? (r.fechaModificacion | date:'yyyy-MM-dd') : (fechaPersonalizada || ''))
            }}
          </td>

          <td class="col-nombre">{{ r.nombre }}</td>
          <td>{{ r.unidad }}</td>

          <td>{{ r.minutosAtraso }}</td>
          <td>{{ r.minutosPagados }}</td>

          <td>{{ r.administracion }}</td>
          <td>{{ r.adminPagada }}</td>

          <td>{{ r.minutosBase }}</td>
          <td>{{ r.minBasePagados }}</td>

          <td>{{ r.multas }}</td>
          <td>{{ r.multasPagadas }}</td>

          <td class="col-acciones">
            <div class="acciones">
              <!-- EDITAR -->
              <button
                type="button"
                class="btn-icono editar"
                title="Editar"
                (click)="irAEditar(r); $event.stopPropagation()"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l9.06-9.06.92.92L5.92 20.08zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
              </button>

              <!-- PAGAR -->
              <button
                type="button"
                class="btn-icono pagar"
                title="Pagar"
                (click)="irAPagar(r); $event.stopPropagation()"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4H4V6h16v2zm-8 8H6v-2h6v2z"/>
                </svg>
              </button>

              <!-- ELIMINAR -->
              <button
                type="button"
                class="btn-icono eliminar"
                title="Eliminar"
                (click)="eliminarReporte(r); $event.stopPropagation()"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M6 7h12v14H6V7zm3-3h6l1 1h4v2H4V5h4l1-1z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <ng-template #sinDatos>
      <div class="sin-datos">
        <p>No hay registros para mostrar.</p>
      </div>
    </ng-template>
  </div>

  <div class="nota-ayuda" *ngIf="!cargando && reportes.length">
    <small>
      Tip: Doble clic sobre una fila para seleccionarla. Las filas seleccionadas se resaltan para eliminar en bloque.
    </small>
  </div>

  <!-- ===================================== -->
  <!-- MODAL: AGREGAR D√çA (FECHA PUNTUAL) -->
  <!-- ===================================== -->
  <div class="modal-backdrop" *ngIf="mostrarModalAgregarDia">
    <div class="modal-card" role="dialog" aria-modal="true">

      <button class="btn-cerrar" type="button" (click)="cerrarModalAgregarDia()">√ó</button>

      <h3>Agregar d√≠a</h3>

      <label>Empresas</label>
      <div class="empresas-fijas">
        <span class="chip-empresa">General Pintag</span>
        <span class="chip-empresa">Expreso Antisana</span>
      </div>

    <label>Fecha</label>

    <div class="date-picker-wrapper" (click)="abrirCalendario(fechaInput)">
      <input
        #fechaInput
        type="date"
        [(ngModel)]="fechaNuevaDia"
        name="fechaNuevaDia"
      />
      <span class="icono-calendario">üìÖ</span>
    </div>


      <p class="error" *ngIf="errorCrearDia">{{ errorCrearDia }}</p>

      <div class="acciones">
        <button class="btn-secundario" type="button" (click)="cerrarModalAgregarDia()">
          Cancelar
        </button>

        <button class="btn-primario" type="button" (click)="confirmarAgregarDia()" [disabled]="creandoDia">
          {{ creandoDia ? 'Creando...' : 'Crear d√≠a' }}
        </button>
      </div>

    </div>
  </div>

</div>
<!-- ===================================== -->
<!-- MODAL: ELIMINAR D√çA (FECHA PUNTUAL) -->
<!-- ===================================== -->
<div class="modal-backdrop" *ngIf="mostrarModalEliminarDia">
  <div class="modal-card" role="dialog" aria-modal="true">

    <button class="btn-cerrar" type="button" (click)="cerrarModalEliminarDia()">√ó</button>

    <h3>Eliminar d√≠a</h3>

    <p class="nota-peligro">
      Esta acci√≥n eliminar√° el d√≠a en <b>ambas empresas</b> (General Pintag y Expreso Antisana),
      incluyendo sus unidades y pagos asociados.
    </p>

    <label>Fecha</label>

    <div class="date-picker-wrapper" (click)="abrirCalendario(fechaEliminarInput)">
      <input
        #fechaEliminarInput
        type="date"
        [(ngModel)]="fechaEliminarDia"
        name="fechaEliminarDia"
      />
      <span class="icono-calendario">üìÖ</span>
    </div>

    <p class="error" *ngIf="errorEliminarDia">{{ errorEliminarDia }}</p>

    <div class="acciones">
      <button class="btn-secundario" type="button" (click)="cerrarModalEliminarDia()">
        Cancelar
      </button>

      <button class="btn-peligro" type="button" (click)="confirmarEliminarDia()" [disabled]="eliminandoDia">
        {{ eliminandoDia ? 'Eliminando...' : 'Eliminar d√≠a' }}
      </button>
    </div>

  </div>
</div>
