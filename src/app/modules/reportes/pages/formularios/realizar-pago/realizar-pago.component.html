<div class="pago-container">
  <div class="pago-header">
    <span class="material-icons icono-pago">payments</span>
    <h4>Gestión de Pago</h4>
  </div>

  <!-- Información del usuario -->
  <div class="info-usuario" *ngIf="registros">
    <p><strong>Nombre:</strong> {{ registros.nombre }} {{ registros.apellido }}</p>
    <p><strong>Unidad:</strong> {{ registros.unidad }}</p>
  </div>

  <!-- =========================
       MÓDULOS DE PAGO
       ========================= -->
  <div class="contenedor-modulos" *ngIf="registros">
    <div class="modulo" *ngFor="let campo of campos">
      <h3>{{ campo | titlecase }}</h3>

      <div class="tabla-pagos">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Pagado</th>
            </tr>
          </thead>

          <tbody>
            <!-- Historial de pagos (solo lectura, doc actual) -->
            <tr class="fila-pago" *ngFor="let pago of filtrarPagosPorRegistro(campo, registros.id!)">
              <td>{{ pago.fecha.toDate() | date:'dd/MM/yyyy' }}</td>
              <td>{{ pago.cantidad }}</td>
            </tr>

            <tr *ngIf="filtrarPagosPorRegistro(campo, registros.id!).length === 0">
              <td colspan="2">Sin pagos registrados</td>
            </tr>

            <tr>
              <td><strong>Total pagado:</strong></td>
              <td><strong>{{ calcularTotalPagado(campo, registros.id!) }}</strong></td>
            </tr>

            <!-- Deuda acumulada (histórica + día actual) -->
            <tr>
              <td><strong>Deuda:</strong></td>
              <td>{{ calcularDeudaAcumulada(campo) }}</td>
            </tr>

            <!-- =========================
                 DESGLOSE POR FECHA
                 PAGO POR FILA
                 ========================= -->
            <tr *ngIf="getDeudaDetalle(campo).length > 0">
              <td colspan="2" class="deuda-detalle-cell">
                <div class="deuda-detalle">
                  <div class="deuda-detalle-titulo">Desglose por fecha</div>

                  <div class="deuda-detalle-lista">
                    <div
                      class="deuda-detalle-item"
                      *ngFor="let item of getDeudaDetalleLimitado(campo, 50)"
                    >
                      <span class="fecha">{{ item.fecha }}</span>
                      <span class="monto">{{ item.monto }}</span>

                      <!-- Input de pago por deuda específica -->
                      <input
                        type="number"
                        class="input-pago-fila"
                        min="0"
                        [max]="item.monto"
                        [ngModel]="getPagoFila(campo, item)"
                        (ngModelChange)="setPagoFila(campo, item, $event)"
                        placeholder="0"
                      />
                    </div>
                  </div>
                </div>
              </td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================
       RESUMEN
       ========================= -->
  <div class="resumen-total">
    <h3>Total a pagar:</h3>
    <p class="total-pagar">${{ calcularTotalGeneral() }}</p>
  </div>

  <!-- =========================
       ACCIONES
       ========================= -->
  <div class="acciones-finales">
    <button class="volver" type="button" (click)="volver()">
      <span class="material-icons">arrow_back_ios_new</span>
      Volver
    </button>

    <button
      class="guardar"
      type="button"
      (click)="guardarPagosGenerales()"
      [disabled]="cargandoPago"
    >
      <span class="material-icons">
        {{ cargandoPago ? 'hourglass_top' : 'task_alt' }}
      </span>
      {{ cargandoPago ? 'Procesando...' : 'Guardar pagos' }}
    </button>
  </div>
</div>
