<div class="perfil-wrapper">
  <div class="perfil-container">
    <h5><span class="material-icons">person</span> Perfil</h5>

    <form (ngSubmit)="guardarCambios()">
      <div class="form-group">
        <label>C√©dula</label>
        <input type="text" [value]="cedula" disabled />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Nombres</label>
          <input type="text" [value]="nombres" disabled />
        </div>
        <div class="form-group">
          <label>Apellidos</label>
          <input type="text" [value]="apellidos" disabled />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Unidad(es)</label>
          <ul class="unit-list">
            <li *ngFor="let unit of unidades">{{ unit.nombre }}</li>
            <li *ngIf="unidades.length === 0">No hay unidades asignadas.</li>
          </ul>
        </div>
        <div class="form-group">
          <label>Empresa</label>
          <input type="text" [value]="empresa" disabled />
        </div>
      </div>

      <div class="form-group">
        <label for="correo">Correo</label>
        <input
          type="email"
          id="correo"
          [(ngModel)]="correo"
          (ngModelChange)="verificarCambios()"
          name="correo"
          required
          [disabled]="soloLectura"
        />
      </div>

      <div class="form-row">
        <div class="form-group" *ngIf="!soloLectura">
          <label for="contrasenaActual">Contrase√±a actual</label>
          <div class="password-input">
            <input
              [type]="showCurrentPassword ? 'text' : 'password'"
              [(ngModel)]="contrasenaActual"
              (ngModelChange)="verificarCambios()"
              name="contrasenaActual"
              id="contrasenaActual"
              placeholder="Contrase√±a actual"
            />
            <button type="button" (click)="togglePasswordVisibility('current')" class="icon-button">
              <span class="material-icons">
                {{ showCurrentPassword ? 'visibility_off' : 'visibility' }}
              </span>
            </button>
          </div>
        </div>

        <div class="form-group" *ngIf="!soloLectura">
          <label for="nuevaContrasena">Nueva contrase√±a</label>
          <div class="password-input">
            <input
              [type]="showNewPassword ? 'text' : 'password'"
              [(ngModel)]="nuevaContrasena"
              (ngModelChange)="verificarCambios()"
              name="nuevaContrasena"
              id="nuevaContrasena"
              placeholder="Nueva contrase√±a"
            />
            <button type="button" (click)="togglePasswordVisibility('new')" class="icon-button">
              <span class="material-icons">
                {{ showNewPassword ? 'visibility_off' : 'visibility' }}
              </span>
            </button>
          </div>
        </div>
      </div>

      <div class="form-actions" *ngIf="!soloLectura">
        <button class="btn-guardar" (click)="guardarCambios()" [disabled]="!hayCambios">
          <span class="material-icons">save</span> Guardar cambios
        </button>

        <button
          type="button"
          class="btn-cancelar"
          *ngIf="nuevaContrasena || contrasenaActual"
          (click)="cancelarCambioContrasena()"
        >
          <span class="material-icons">cancel</span> Cancelar cambio de contrase√±a
        </button>
      </div>


      <div class="form-actions">
        <button
          type="button"
          class="btn-volver"
          *ngIf="esAdmin"
          (click)="volverAlMenu()"
        >
          <span class="material-icons">arrow_back</span> Volver al men√∫
        </button>
        <div class="form-actions" >
          <button  class="btn-eliminar" *ngIf="esAdmin" (click)="eliminarUsuario()">
            <span class="material-icons">delete</span> Eliminar usuario
          </button>
        </div>
      </div>
    </form>

      
  </div>

  <div class="perfil-derecho">
    <div class="tabla-reportes-usuario">
      <div class="tabla-scroll-horizontal">
        <h3>üìÑ Tus Reportes Registrados</h3>
        <div class="loading" *ngIf="cargando">
        <div class="spinner"></div>
        <p>Cargando reportes...</p>
      </div>
        <table *ngIf="!cargando && reportesUsuario.length > 0">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Unidad</th>
              <th>Min. Atraso</th>
              <th>Min. Atraso Pagados</th>
              <th>Admin</th>
              <th>Admin Pagada</th>
              <th>Min. Base</th>
              <th>Min. Base Pagados</th>
              <th>Multas</th>
              <th>Multas Pagadas</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reporte of reportesUsuario">
              <td>{{ reporte.fechaModificacion | date: 'shortDate' }}</td>
              <td>{{ reporte.unidad }}</td>
              <td>{{ reporte.minutosAtraso }}</td>
              <td>{{ reporte.minutosPagados }}</td>
              <td>{{ reporte.administracion }}</td>
              <td>{{ reporte.adminPagada }}</td>
              <td>{{ reporte.minutosBase }}</td>
              <td>{{ reporte.minBasePagados }}</td>
              <td>{{ reporte.multas }}</td>
              <td>{{ reporte.multasPagadas }}</td>
            </tr>
          </tbody>
        </table>
        <p *ngIf="!cargando &&reportesUsuario.length === 0">A√∫n no tienes reportes registrados.</p>
        <div class="tabla-recibos-usuario">
          <h3>üì• Recibos de Pagos</h3>
          <table *ngIf="pagosPaginados.length > 0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Total Pagado</th>
                <th>Descargar</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let pago of pagosPaginados">
                <td>{{ pago.fecha | date: 'short' }}</td>
                <td>{{ pago.total | currency: 'USD' }}</td>
                <td>
                  <button class="btn-icon" (click)="descargarPDF(pago.urlPDF)">
                    <span class="material-icons">download</span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <p *ngIf="pagosPaginados.length === 0">No se han generado pagos a√∫n.</p>

          <div class="paginacion">
            <button (click)="cambiarPaginaPagos(-1)" [disabled]="paginaActualPagos === 1">¬´ Anterior</button>
            <span>P√°gina {{ paginaActualPagos }} de {{ totalPaginasPagos }}</span>
            <button (click)="cambiarPaginaPagos(1)" [disabled]="paginaActualPagos >= totalPaginasPagos">Siguiente ¬ª</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üîò Modal de confirmaci√≥n -->
<div class="modal-overlay" *ngIf="mostrarConfirmacion">
  <div class="modal">
    <h3>‚ö†Ô∏è Confirmar eliminaci√≥n</h3>
    <p>¬øDeseas eliminar este usuario completamente (Firestore + Auth)?</p>
    <p class="texto-advertencia">Esta acci√≥n no se puede deshacer.</p>
    <div class="modal-buttons">
      <button class="btn-cancelar" (click)="cancelarEliminacion()">Cancelar</button>
      <button class="btn-eliminar" (click)="confirmarEliminacion()">Eliminar</button>
    </div>
  </div>
</div>

<!-- ‚è≥ Spinner mientras se elimina -->
<div class="overlay-spinner" *ngIf="eliminando">
  <div class="spinner"></div>
  <p>Eliminando usuario...</p>
</div>
